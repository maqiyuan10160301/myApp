<html>
    <head>
        <title>最佳工作序列</title>
    </head>
    <body>
        <table border="1" align="center" id="table">
            <tr align="center" id="table"><td colspan="6">请输入任务数</td>
            <td><input type="number" id="missionnum" value="4"/></td>
            <td><input type="button" id="confirm" value="确定" onclick="receivenum()"></td></tr>
        </table>
        <script>
            //获取任务数量，并由用户输入具体信息
            function receivenum()
            {
                var mytable = document.getElementById("table");
                for(var i = 1;i<=Number(document.getElementById("missionnum").value);i++)
                {
                    var trNode = mytable.insertRow();
                    for (var j = 1;j<=8;j++)
                    {
                        var tdNode = trNode.insertCell();
                        var nodeId = "r"+String(i)+"d"+String(j);
                        if(j==1)
                        {
                            tdNode.innerHTML="序号";
                            tdNode.setAttribute("align","center");
                        }
                        else if(j==2)
                        {
                            var myinput = document.createElement("input");
                            myinput.setAttribute("type","textarea");
                            myinput.setAttribute("id","r"+String(i)+"d"+String(j));
                            tdNode.appendChild(myinput);
                        }
                        else if(j==3)
                        {
                            tdNode.innerHTML="用时";
                            tdNode.setAttribute("align","center");
                        }
                        else if(j==4)
                        {
                            var myinput = document.createElement("input");
                            myinput.setAttribute("type","textarea");
                            myinput.setAttribute("id","r"+String(i)+"d"+String(j));
                            tdNode.appendChild(myinput);
                        }
                        else if(j==5)
                        {
                            tdNode.innerHTML="期限";
                            tdNode.setAttribute("align","center");
                        }
                        else if(j==6)
                        {
                            var myinput = document.createElement("input");
                            myinput.setAttribute("type","textarea");
                            myinput.setAttribute("id","r"+String(i)+"d"+String(j));
                            tdNode.appendChild(myinput);
                        }
                        else if(j==7)
                        {
                            tdNode.innerHTML="效益";
                            tdNode.setAttribute("align","center");
                        }
                        else if(j==8)
                        {
                            var myinput = document.createElement("input");
                            myinput.setAttribute("type","textarea");
                            myinput.setAttribute("id","r"+String(i)+"d"+String(j));
                            tdNode.appendChild(myinput);
                        }
                    }
                }
                if(Number(document.getElementById("missionnum").value)==4)
                {
                    document.getElementById("r1d2").setAttribute("value","1");
                    document.getElementById("r1d4").setAttribute("value","4");
                    document.getElementById("r1d6").setAttribute("value","10");
                    document.getElementById("r1d8").setAttribute("value","2");
                    document.getElementById("r2d2").setAttribute("value","2");
                    document.getElementById("r2d4").setAttribute("value","3");
                    document.getElementById("r2d6").setAttribute("value","8");
                    document.getElementById("r2d8").setAttribute("value","3");
                    document.getElementById("r3d2").setAttribute("value","3");
                    document.getElementById("r3d4").setAttribute("value","2");
                    document.getElementById("r3d6").setAttribute("value","4");
                    document.getElementById("r3d8").setAttribute("value","3");
                    document.getElementById("r4d2").setAttribute("value","4");
                    document.getElementById("r4d4").setAttribute("value","1");
                    document.getElementById("r4d6").setAttribute("value","2");
                    document.getElementById("r4d8").setAttribute("value","6");
                }
                var trNode = mytable.insertRow();
                var tdNode = trNode.insertCell();
                tdNode.setAttribute("colspan","8");
                tdNode.setAttribute("align","center");
                var myinput = document.createElement("input");
                myinput.setAttribute("type","button");
                myinput.setAttribute("id","submit");
                myinput.setAttribute("value","提交");
                myinput.onclick=main;
                tdNode.appendChild(myinput);
                n = document.getElementById("missionnum").value;
            }
            
            function initJs(js,profit,n,pmin,minimum)
            {
                js[0].jobnum = 0;
                js[0].pb = 0;
                js[0].time = 0;
                js[0].last = 0;
                js[0].parent = 0;
                js[0].depth = 0;
                js[0].index = 0;
                for(var i = 1;i<=n;i++)
                {
                    js[0].finished[i] = 0;
                    js[0].pb += profit[i];
                }
                pmin = js[0];
                minimum = js[0];
            }
            
            //如果a与bound同层的祖先结点的序号在bound之前
            //则认为可能可以改进
            function canProcess(a,bound)
            {
                while(a.depth>bound.depth)
                {
                    a = rc[a.parent];
                }
                if(a.index<bound.index)
                    return 1;
                return 0;
            }

            //寻找以p为父亲结点所有的子结点
            function search(js,arr,n,p)
            {
                if(js[p].last<n)//如果到达最后的工作则无子节点
                {
                    for(var i = 0;i <= n;i++)
                        js[num + 1].finished[i]=js[p].finished[i];
                    js[num+1].finished[js[p].last+cn]=1;
                    js[num+1].last = js[p].last+cn;
                    //总费时在截止时间前
                    if(js[p].time+arr.time[js[p].last+cn]<=arr.deadline[js[p].last+cn])
                    {
                        js[num+1].pb = 0
                        for(var i = 1;i<=n;i++)//计算剩余价值
                        {
                            if(js[num+1].finished[i]==0)
                                js[num+1].pb += arr.profit[i];
                        }
                        js[num+1].parent = p;
                        js[num+1].depth = js[p].depth+1;
                        js[num+1].index = num+1;
                        //如果剩余总价值小于最小剩余价值或有更优解的可能，确定子结点
                        if(js[num+1].pb<=pmin.pb||canProcess(js[num+1],pmin))
                        {
                            num++;
                            //更新已完成工作总时间
                            js[num].time = js[p].time + arr.time[js[p].last+cn];
                            if(minimum.pb>js[num].pb)
                                minimum = js[num];
                            queue.push(js[num]);
                        }
                    }
                    cn++;
                    if(cn<n-js[p].last+1)//如果未找到最右边的孩子
                        search(js,arr,n,p);//寻找右兄弟
                    else
                        return 0;
                }
            }

            var bottom = 0;
            var queue = new Array();
            var n = 0;
            var num = 0;
            var cn = 0;
            var rc = new Array();
            var k = 0;
            var Jobs;
            var minimum;
            var pmin;
            var Job;
            function main()
            {
                bottom = 0;         //定义队首位置
                queue = new Array();//定义队列
                n = 0;
                num = 0;                        //树实际结点数
                cn = 0;                         //一个结点的孩子数
                rc = new Array();               //所有结点
                k = 0;
                Jobs = {
                    finished : new Array(n),//记录已完成的工作序列
                    pb : undefined,         //剩余价值的和
                    time : undefined,       //最后一项工作完成时间
                    last : undefined,       //完成最后一项工作的序号
                    parent : undefined,     //记录父结点
                    jobnum : undefined,     //总工作数
                    depth : undefined,      //深度
                    index : undefined       //下标
                }
                minimum = Object.create(Jobs);  //当前剩余价值最小值
                pmin = Object.create(Jobs);     //一层中剩余价值最小值
                Job = {
                    id : new Array(),
                    time : new Array(),
                    deadline : new Array(),
                    profit : new Array()
                }
                var text="";
                var arr = Object.create(Job);
                arr.id = [0];
                arr.time = [0];
                arr.deadline = [0];
                arr.profit = [0];
                for(var i=1;i<=Number(document.getElementById("missionnum").value);i++)
                {
                    arr.id.push(document.getElementById("r"+String(i)+"d2").value);
                    arr.time.push(Number(document.getElementById("r"+String(i)+"d4").value));
                    arr.deadline.push(Number(document.getElementById("r"+String(i)+"d6").value));
                    arr.profit.push(Number(document.getElementById("r"+String(i)+"d8").value));
                }
                var n = arr.id.length-1;
                var p = -1;             //父结点
                //按完成期限由小到大排序
                for(var i = 1;i < n+1;i++)
                    for(var j = 2;j<n-i+2;j++)
                        if(arr.deadline[j-1]>arr.deadline[j])
                        {
                            temp = arr.profit[j-1];
                            arr.profit[j-1] = arr.profit[j];
                            arr.profit[j] = temp;
                            temp = arr.id[j-1];
                            arr.id[j-1] = arr.id[j];
                            arr.id[j] = temp;
                            temp = arr.deadline[j-1];
                            arr.deadline[j-1] = arr.deadline[j];
                            arr.deadline[j] = temp;
                            temp = arr.time[j-1];
                            arr.time[j-1] = arr.time[j];
                            arr.time[j] = temp;
                        }
                
                var js = new Array();
                for(var i = 0;i<n;i++)
                    js.push(Object.create(Jobs));
                initJs(js,arr.profit,n,pmin,minimum);
                var u = Object.create(Jobs);
                var v = Object.create(Jobs);
                var flag = Object.create(Jobs);
                queue.push(js[0]);
                queue.push(flag);
                while(bottom != queue.length)//队列非空
                {
                    u = queue[bottom];
                    bottom += 1;
                    rc.push(u);
                    if(u == flag)//一层全部出队
                    {
                        pmin = minimum;//处理完一层最后一个结点后更新一层中剩余价值最小值
                        queue.push(flag);
                        if(v == flag)   break;//上一个出队也是flag时，队列为空
                    }
                    else
                    {
                        p += 1;
                        cn = 1;//从第一个孩子开始查找
                        search(js,arr,n,p);//查找u所有孩子，全部入队
                    }
                    v = u;//v为上一个出队元素
                }
                
                //输出结果
                var t = "";
                var sum = 0;
                for(var i = 1;i<=n;i++)
                {
                    if(pmin.finished[i] == 1)
                    {
                        t += String(arr.id[i]);
                        t += " ";
                        sum += arr.profit[i];
                    }
                }
                var mytable = document.getElementById("table");
                var trNode = mytable.insertRow();
                var tdNode = trNode.insertCell();
                tdNode.setAttribute("align","center");
                tdNode.setAttribute("rowspan","2");
                tdNode.setAttribute("colspan","8");
                tdNode.innerHTML = "工作序列: "+t+"<br>总效益: "+String(sum);
            }
        </script>
    </body>
</html>